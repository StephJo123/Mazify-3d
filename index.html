<!DOCTYPE html>
<html>

<head>
  <title>Mazify 3D</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <meta name="description" content="Mazify 3D" />
  <script src="https://aframe.io/releases/1.1.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>
  <script src="https://recast-api.donmccurdy.com/aframe-inspector-plugin-recast.js"></script>
  <script src="https://unpkg.com/aframe-super-shooter-kit/dist/aframe-super-shooter-kit.min.js"></script>
  <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
  <script src="js/mazify.js"></script>
  <script src="js/player.js"></script>
  <script src="THREE.MeshLine.js"></script>
  <script>
    var bombactive = false;
    /* Permet de tirer */
    AFRAME.registerComponent('click-to-shoot', {
      init: function () {
        document.body.addEventListener('mousedown', () => { this.el.emit('shoot'); });
      }
    });

    /* Joue la musique d'ambiance 
    document.addEventListener('click', musicPlay);
    function musicPlay() {
      document.getElementById('musique').play();
      document.removeEventListener('click', musicPlay);
    }  */

    /* Son de l'arme quand elle tire */
    AFRAME.registerComponent('audiohandler', {
      init: function () {
        let audio = document.querySelector("#sonArme");
        this.el.addEventListener('click', () => {
          audio.play();
          audio.currentTime = 0;
        });
      }
    });

    AFRAME.registerComponent('fin', {
      init: function () {
        this.el.addEventListener('click', function (evt) {
          document.getElementById("finishDialog").style.display = "block";
        });
      }
    });

    AFRAME.registerComponent('change-color-on-click', {
      init: function () {
        this.el.addEventListener('click', function (evt) {
          document.getElementById("finishDialog").style.display = "block";
          document.querySelector('a-scene').exitVR();
        });
      }
    });

    AFRAME.registerComponent('hit-test', {
      dependencies: ['material'],
      init: function () {
        var el = this.el;
        el.addEventListener('hit', () => {
          document.getElementById("finishDialog").style.display = "block";
        });
        el.addEventListener('die', () => {
          document.getElementById("finishDialog").style.display = "block";
        });
      }
    });


    AFRAME.registerComponent('trackball', {
      tick: function () {

        if (bombactive)
          return;

        function abs(val) {
          return (val < 0) ? -val : val;
        }
        let pos = this.el.getAttribute("position");

        let posSphere = document.querySelector("a-sphere").getAttribute("position");
        if (abs(pos.x - posSphere.x) < 4) {
          if (abs(pos.z - posSphere.z) < 4) {
            bombactive = true;
            document.getElementById("tbombe").setAttribute("visible", "true");
            document.getElementById("compteur").setAttribute("visible", "true");


            function startTimer(duration, display) {
              var timer = duration, minutes, seconds;
              var monInter = setInterval(function () {
                document.getElementById("compteur").setAttribute("text", "value: " + timer + ";");
                minutes = parseInt(timer / 60, 10)
                seconds = parseInt(timer % 60, 10);

                minutes = minutes < 10 ? "0" + minutes : minutes;
                seconds = seconds < 10 ? "0" + seconds : seconds;

                display.textContent = minutes + ":" + seconds;

                if (!document.getElementById('tinterrupteur').getAttribute('visible')) {
                  if (--timer < 0) {
                    document.getElementById("BombeDialogue").style.display = "block";
                    document.querySelector('a-scene').exitVR();
                  }
                }
              }, 1000);

              setTimeout(function () {
                clearInterval(monInter);
              }, 31000);
            }

            var trenteSecondes = 30,
              display = document.getElementById("time2");
            startTimer(trenteSecondes, display);

            document.getElementById('interrupteur2').addEventListener('click', function (evt) {
              document.getElementById("compteur").setAttribute("visible", "false");
              document.getElementById('tinterrupteur').setAttribute('visible', "true");
            });
          }
        }
      }
    });
    AFRAME.registerComponent('enemyfollow', {
      tick: function () {
        let posCamera = this.el.getAttribute("position");
      }
    })
    AFRAME.registerComponent('trackballfinish', {
      tick: function () {
        function abs(val) {
          return (val < 0) ? -val : val;
        }
        let pos = this.el.getAttribute("position");

        let posSphere = document.getElementById("fini2").getAttribute("position");

        if (abs(pos.x - posSphere.x) < 2) {
          if (abs(pos.z - posSphere.z) < 2) {
            document.getElementById("finishDialog").style.display = "block";
            document.querySelector('a-scene').exitVR();
          }
        }
      }
    });



    AFRAME.registerComponent('hit-handler', {
      dependencies: ['material'],

      init: function () {
        var positionTmp = this.positionTmp = this.positionTmp || { x: 0, y: 0, z: 0 };
        var el = this.el;

        el.addEventListener('hit', () => {
          document.getElementById("finishDialog").style.display = "block";
        });

        el.addEventListener('die', () => {

          var position = el.getAttribute('position');
          positionTmp.x = position.x + 0.1;
          positionTmp.y = position.y - 100000;
          positionTmp.z = position.z + 0.1;
          el.setAttribute('position', positionTmp);
        });
      }
    });
    AFRAME.registerComponent('shoot-ennemy', {
      init: function () {
        let enemy = this.el;
        setInterval(function () {
          enemy.emit('shoot');
        }, 1000);
      }
    });
  </script>
  <script>
    AFRAME.registerComponent('emit-when-colliding', {
      schema: {
        target: { type: 'selector', default: '#player' },
        distance: { type: 'number', default: 1 },
        event: { type: 'string', default: 'collided' }
      },
      init: function () {
        this.tick = AFRAME.utils.throttleTick(this.checkDist, 200, this);
        this.emiting = false;
      },
      checkDist: function () {
        let myPos = new THREE.Vector3(0, 0, 0);
        let targetPos = new THREE.Vector3(0, 0, 0);
        this.el.object3D.getWorldPosition(myPos);
        this.data.target.object3D.getWorldPosition(targetPos);
        let distanceTo = myPos.distanceTo(targetPos);
        if (distanceTo < this.data.distance && !this.emiting) {
          this.emiting = true;
          this.el.emit(this.data.event, { collidingEntity: this.data.target }, false);
          this.data.target.emit(this.data.event, { collidingEntity: this.el }, false);
        } else {
          this.emiting = false;
        }
      }
    });
  </script>
  <link href="https://fonts.googleapis.com/css?family=Spartan&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="css/style.css" />
</head>

<body style="background-color: #222222">
  <div id="loader" class="lds-dual-ring centered"></div>
  <a-scene style="display: none;" inspector-plugin-recast renderer=" colorManagement: true;">
    <!-- Assets -->
    <a-assets>
      <img id="ground" src="assets/sol.jpg" />
      <img id="wall" src="assets/test.jpg" />
      <img id="ball" src="assets/ball.jpg" />
      <img id="red-carpet" src="assets/red-carpet.jpg" />
      <img id="start" src="assets/start.jpg" />
      <img id="finish" src="assets/finish.jpg" />
      <img id="redsky" src="assets/t.jpg">
      <img id="texteBombe" src="assets/textebombe.png">
      <img id="texteInterrupteur" src="assets/texteInterrupteur.png">
      <a-asset-item id="interrupteur" src="assets/light_switch/scene.gltf"></a-asset-item>
      <a-asset-item id="my-nav-mesh" src="assets/navmesh.gltf"></a-asset-item>
      <a-asset-item id="gun" src="assets/sci-fi_revolver/scene.gltf"></a-asset-item>
      <a-asset-item id="fini" src="assets/finish/scene.gltf"></a-asset-item>
      <a-asset-item id="ennemy" src="assets/cultist_armed/scene.gltf"></a-asset-item>
      <a-asset-item id="dragon" src="assets/mythic_dragon_variant/scene.gltf"></a-asset-item>
      <a-asset-item id="cyclops" src="assets/cyclops/scene.gltf"></a-asset-item>
      <a-asset-item id="bomb" src="assets/atomic_bomb/scene.gltf"></a-asset-item>
      <audio id="sonArme" src="assets/pistol.mp3" preload="auto"></audio>
      <audio id="musique" src="assets/critical-tension-drama-tension-suspense-music-brulik-entertainment.mp3"></audio>
      <a-asset-item id="human" src="assets/super_human/scene.gltf"></a-asset-item>
    </a-assets>

    <!-- Environment -->

    <a-sky src="#redsky">
    </a-sky>

    <a-light type="ambient" color="#fff" intensity="0.8"></a-light>
    <a-plane material="src: #ground; repeat: 25 25" rotation="-90 0 0" height="100" width="100"></a-plane>

    <!--Interrupteur-->
    <a-entity gltf-model="#interrupteur" id="interrupteur2" onclick="" trackball scale="15 15 15"
      position="-22.519 1.576 -21">
    </a-entity>
    <a-image src="#texteInterrupteur" id="tinterrupteur" position="-21.0 1.845 -21.8" rotation="0 45 0"
      scale="0.09 0.09 0.09" height="8" width="20" visible="false"
      animation="property: position; to: -21.0 2.1 -21.8; loop: true; dur: 4000; dir: alternate"></a-image>

    <!--Bombe-->
    <a-entity gltf-model="#bomb" id="bomb" scale="0.02 0.02 0.02" position="-2.76 2 -6" rotation="270 0 0">
    </a-entity>
    <a-cone id="fini2" position="18.6 1 -21.14" scale="0.002 0.002 0.002" radius="0.25" color="#EF2D5E" dynamic-body>
    </a-cone>

    <!--Finish-->
    <a-sphere id="sphere" position="-2.76 2.3 -6" radius="0.25" color="#EF2D5E" dynamic-body></a-sphere>

    <a-image src="#texteBombe" id="tbombe" position="-0.711 2.387 -4.168" rotation="0 -45 0" scale="0.09 0.09 0.09"
      height="8" width="20" visible="false"
      animation="property: position; to: -0.711 2.6 -4.168; loop: true; dur: 4000; dir: alternate"></a-image>


    <!-- Tracking des mains -->
    <a-entity id="leftHand" hand-tracking-controls="hand: left;"></a-entity>
    <a-entity id="rightHand" hand-tracking-controls="hand: right;"></a-entity>

    <!-- Gestion des balles -->
    <a-entity bullet="name: normal; speed: 20.0; poolSize: 20" geometry="primitive: icosahedron; radius: 0.1;"
      material="color: #FF7; emissiveIntensity: 0.5; emissive: #FF7"></a-entity>

    <!-- Caméra Rig -->
    <a-entity id="player" player listener movement-controls="constrainToNavMesh: true" position="0 1.6 0"
      animation__teleportx="property: object3D.position.x; to: 0; dur: 10; easing: linear; startEvents: teleport"
      animation__teleportz="property: object3D.position.z; to: 1; dur: 10; easing: linear; startEvents: teleport"
      trackball trackballfinish>
      <!-- Caméra -->
      <a-entity position="0 1.6 0" look-controls id="camera" camera="userHeight: 1.6" listener>
        <a-cursor></a-cursor>
        <a-entity id="compteur" text="value: ; align: center;" position="0 0 -1" scale="2.5 2.5 2.5" visible="false">
        </a-entity>
      </a-entity>
      <!-- Main gauche -->
      <a-entity oculus-touch-controls="hand: left" hand-controls="hand: left; handModelStyle: highPoly; color: #B3B3B3">
      </a-entity>
      <!-- Main droite -->
      <a-entity oculus-touch-controls="hand: right"
        hand-controls="hand: right; handModelStyle: highPoly ; color: #B3B3B3" shooter="activeBulletType: normal"
        position="0.5 -0.7 -1.2" class="vr-except">
        <!-- Pistolet  -->
        <a-entity gltf-model="#gun" scale="0.012 0.012 0.012" position="0 0.05 -0.12" click-to-shoot shooter></a-entity>
      </a-entity>

    </a-entity>

    <a-box material="color: black; opacity: 0.2; transparent: true" position="-27 0.5 11"
      emit-when-colliding="target: #player; event: teleport; distance: 1"></a-box>

    <a-entity gltf-model="#my-nav-mesh" nav-mesh position="0 -0.1 0" visible="false">
    </a-entity>

    <a-entity rotation="0 0 0" animation="property: rotation; to: 0 -360 0; loop: true; dur: 35000">
      <a-entity gltf-model="#dragon" animation-mixer id="dragon" scale="1.5 1.5 1.5" position="20 15 0">
        <a-box scale="0.0005 0.0005 0.0005" position="0 2.4 0" shoot-ennemy shooter rotation="270 0 0">
        </a-box>
      </a-entity>
    </a-entity>

    <a-entity gltf-model="#cyclops" animation-mixer id="cyclops" scale="0.2 0.2 0.2" position="-1.198 0 23.962"
      rotation="0 -90 0" animation="property: position; to: -22.5 0 23.962; loop: false; dur: 35000" look-at="#player"
      target="healthPoints: 3" hit-handler>

      <a-box shoot-ennemy shooter position="0.118 12.3 3.370" scale="0.001 0.001 0.001" rotation="315 -180 0"></a-box>
    </a-entity>
    <a-entity gltf-model="#cyclops" animation-mixer id="cyclops2" scale="0.2 0.2 0.2" position="-24 0 17.5" hit-handler>
      <a-box position="0.118 12.3 3.370" scale="0.001 0.001 0.001" rotation="315 -180 0"></a-box>
    </a-entity>


    <!--
      <a-entity gltf-model="#dragon" id="dragon" scale="1 1 1 " position="-24 0 0.5" animation-mixer look-at="#player" target="healthPoints: 3" hit-handler>
      </a-entity>
      <a-entity gltf-model="#dragon" id="dragon2" scale="1 1 1 " position="-21.7 0 -15.2" animation-mixer look-at="#player" target="healthPoints: 3" hit-handler>
      </a-entity>
      <a-entity gltf-model="#dragon" id="dragon3" scale="1 1 1 " position="-6.2 0 -24.2" animation-mixer look-at="#player" target="healthPoints: 3" hit-handler>
      </a-entity>
      <a-entity gltf-model="#dragon" id="dragon4" scale="1 1 1 " position="0 0 -24.2" animation-mixer look-at="#player" target="healthPoints: 3" hit-handler>
      </a-entity>
      <a-entity gltf-model="#dragon" id="dragon5" scale="1 1 1 " position="2.8 0 -3" animation-mixer look-at="#player" target="healthPoints: 3" hit-handler>
      </a-entity>
      <a-entity gltf-model="#dragon" id="dragon6" scale="1 1 1 " position="-8.7 0 -3" animation-mixer look-at="#player" target="healthPoints: 3" hit-handler>
      </a-entity>
      <a-entity gltf-model="#dragon" id="dragon7" scale="1 1 1 " position="-10.8 0 12" animation-mixer look-at="#player" target="healthPoints: 3" hit-handler>
      </a-entity>
      <a-entity gltf-model="#dragon" id="dragon8" scale="1 1 1 " position="-2.8 0 12" animation-mixer look-at="#player" target="healthPoints: 3" hit-handler>
      </a-entity>
      <a-entity gltf-model="#dragon" id="dragon9" scale="1 1 1 " position="12.3 0 16.3" animation-mixer look-at="#player" target="healthPoints: 3" hit-handler>
      </a-entity>
      <a-entity gltf-model="#dragon" id="dragon10" scale="1 1 1 " position="24.7 0 19"  animation-mixer look-at="#player" target="healthPoints: 3" hit-handler>
      </a-entity>
      <a-entity gltf-model="#dragon" id="dragon11" scale="1 1 1 " position="15.1 0 5.9" animation-mixer look-at="#player" target="healthPoints: 3" hit-handler>
      </a-entity>
      <a-entity gltf-model="#dragon" id="dragon12" scale="1 1 1 " position="12 0 -15" animation-mixer look-at="#player" target="healthPoints: 3" hit-handler>
      </a-entity>
      <a-entity gltf-model="#dragon" id="dragon13" scale="1 1 1 " position="6.3 0 -9.3" animation-mixer look-at="#player" target="healthPoints: 3" hit-handler>
      </a-entity>
      <a-entity gltf-model="#dragon" id="dragon14" scale="1 1 1 " position="-11.8 0 -9.3" animation-mixer look-at="#player" target="healthPoints: 3" hit-handler>
      </a-entity>
      <a-entity gltf-model="#dragon" id="dragon15" scale="1 1 1 " position="24.4 0 -24.5"  animation-mixer look-at="#player" target="healthPoints: 3" hit-handler>
      </a-entity> -->

    <!-- <a-entity id="fin" gltf-model="#fini" scale="0.0075 0.0075 0.0075" position="20 0 -21" rotation="0 90 0" change-color-on-click=''>
      </a-entity> -->

    <!-- <a-box id="tourelle" position="-24 1.5 11.4" shoot-ennemy shooter rotation="0 180 0"></a-box> -->

    <!-- Maze -->
    <a-entity mazify> </a-entity>

    <!-- Finish -->

  </a-scene>


  <div id="time2" style="display: block;">0</div>

  <!-- Model Gagner -->
  <div id="finishDialog" class="modal mazify" style="display: none;">
    <!-- Modal content -->
    <div class="modal-content">
      <div class="modal-header">
        <span class="close" onclick="cont()">&times;</span>
        <h2>Terminé</h2>
      </div>
      <div class="modal-body">
        <p>Félicitation</p>

        <p id="temps"></p>
      </div>
      <div class="modal-footer">
        <h3></h3>
        <button class="button" onclick="reset()">Rejouer</button>
        <button class="button" onclick="save()">Afficher score</button>
      </div>
    </div>
  </div>

  <!-- Model Bombe -->
  <div id="BombeDialogue" class="modal mazify" style="display: none;">
    <!-- Modal content -->
    <div class="modal-content">
      <div class="modal-header">
        <span class="close" onclick="cont()">&times;</span>
        <h2>Perdu !</h2>
      </div>
      <div class="modal-body">
        <p>La Bombe a explosé</p>

        <p id="temps"></p>
      </div>
      <div class="modal-footer">
        <h3></h3>
        <button class="button" onclick="reset()">Rejouer</button>
      </div>
    </div>
  </div>
  <script>

    const departMinutes = 0.01
    let temps = departMinutes * 60
    var secondes = 0;

    setInterval(() => {
      let minutes = parseInt(temps / 60, 10)

      minutes = minutes < 10 ? "0" + minutes : minutes
      secondes = secondes < 10 ? "0" + secondes : secondes

      temps = temps <= 0 ? 0 : temps + 1
    }, 1000)

    function save() {
      var saisie = document.getElementById("timer").innerHTML;
      document.getElementById("temps").innerHTML = "Vous avez franchi la ligne d'arrivée en " + saisie;
    }
  </script>
</body>

</html>